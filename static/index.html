<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Scanner</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <style>
        .device-card {
            transition: all 0.3s ease;
        }
        .device-card:hover {
            transform: translateY(-2px);
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .scanning-indicator {
            animation: pulse 2s infinite;
        }
        .manufacturer-details {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <el-main>
                <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                    <!-- Header -->
                    <el-card class="mb-4">
                        <h1 style="font-size: 24px; margin-bottom: 16px;">Bluetooth Scanner</h1>
                        
                        <!-- Control Panel -->
                        <el-row :gutter="20" align="middle">
                            <el-col :span="6">
                                <el-button 
                                    :type="scanning ? 'danger' : 'primary'"
                                    :loading="loading"
                                    @click="toggleScan"
                                >
                                    {{ scanning ? 'Stop Scan' : 'Start Scan' }}
                                </el-button>
                            </el-col>
                            
                            <el-col :span="12">
                                <div v-if="scanning" style="display: flex; align-items: center; gap: 8px;">
                                    <div class="scanning-indicator" style="width: 12px; height: 12px; background-color: #409EFF; border-radius: 50%;"></div>
                                    <span>Scanning for devices...</span>
                                </div>
                            </el-col>
                            
                            <el-col :span="6" style="text-align: right;">
                                <span>Devices found: </span>
                                <el-tag>{{ Object.keys(devices).length }}</el-tag>
                            </el-col>
                        </el-row>
                        
                        <!-- WebSocket Status -->
                        <div style="margin-top: 16px;">
                            <el-text :type="wsConnected ? 'success' : 'danger'">
                                Connection: {{ wsConnected ? 'Connected' : 'Disconnected' }}
                            </el-text>
                        </div>
                        
                        <!-- Device Type Statistics -->
                        <el-row v-if="Object.keys(devices).length > 0" :gutter="20" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E4E7ED;">
                            <el-col :span="6" style="text-align: center;">
                                <el-statistic title="iBeacons" :value="getDeviceCountByType('ibeacon')" />
                            </el-col>
                            <el-col :span="6" style="text-align: center;">
                                <el-statistic title="Eddystone" :value="getDeviceCountByType('eddystone')" />
                            </el-col>
                            <el-col :span="6" style="text-align: center;">
                                <el-statistic title="AirPods" :value="getDeviceCountByType('airpods')" />
                            </el-col>
                            <el-col :span="6" style="text-align: center;">
                                <el-statistic title="Others" :value="Object.keys(devices).length - getDeviceCountByType('ibeacon') - getDeviceCountByType('eddystone') - getDeviceCountByType('airpods')" />
                            </el-col>
                        </el-row>
                    </el-card>
                    
                    <!-- Filter and Sort -->
                    <el-card class="mb-4">
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-input 
                                    v-model="filter.name"
                                    placeholder="Filter by name..."
                                    clearable
                                >
                                    <template #prefix>
                                        <el-icon><Search /></el-icon>
                                    </template>
                                </el-input>
                            </el-col>
                            <el-col :span="8">
                                <el-input-number 
                                    v-model="filter.minRssi"
                                    :min="-120"
                                    :max="0"
                                    placeholder="Min RSSI"
                                    style="width: 100%;"
                                />
                            </el-col>
                            <el-col :span="8">
                                <el-select v-model="sortBy" placeholder="Sort by" style="width: 100%;">
                                    <el-option label="Signal Strength" value="rssi" />
                                    <el-option label="Name" value="name" />
                                    <el-option label="Discovery Time" value="discovered" />
                                    <el-option label="Distance (Beacons)" value="distance" />
                                </el-select>
                            </el-col>
                        </el-row>
                    </el-card>
                    
                    <!-- Device List -->
                    <el-row :gutter="20">
                        <el-col v-for="device in filteredAndSortedDevices" :key="device.address" :xs="24" :sm="12" :md="8" :lg="8">
                            <el-card class="device-card mb-4" shadow="hover">
                                <!-- Device Header -->
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px;">{{ device.name || 'Unknown Device' }}</h3>
                                        <el-text type="info" size="small" style="font-family: monospace;">{{ device.address }}</el-text>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 24px; font-weight: bold;" :style="{ color: getRssiColor(device.rssi) }">
                                            {{ device.rssi }}
                                            <span style="font-size: 12px; font-weight: normal;">dBm</span>
                                        </div>
                                        <el-tag size="small" :type="getRssiType(device.rssi)">
                                            {{ getRssiStrength(device.rssi) }}
                                        </el-tag>
                                    </div>
                                </div>
                                
                                <!-- Device Info -->
                                <div style="margin-bottom: 16px;">
                                    <div style="margin-bottom: 8px;">
                                        <el-text type="info" size="small">Last seen: </el-text>
                                        <el-text size="small">{{ formatTime(device.timestamp) }}</el-text>
                                    </div>
                                    
                                    <!-- Manufacturer/Vendor Info -->
                                    <div v-if="device.decoded_manufacturer && Object.keys(device.decoded_manufacturer).length > 0">
                                        <div v-for="(mfgData, companyId) in device.decoded_manufacturer" :key="device.address + '-' + companyId" 
                                             style="background-color: #F5F7FA; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <el-text strong>{{ mfgData.company_name }}</el-text>
                                                <el-text type="info" size="small">ID: 0x{{ parseInt(companyId).toString(16).padStart(4, '0').toUpperCase() }}</el-text>
                                            </div>
                                            
                                            <!-- Device Type Badge -->
                                            <el-tag v-if="mfgData.type" size="small" style="margin-top: 4px;"
                                                   :type="getDeviceTypeTagType(mfgData.type)">
                                                {{ mfgData.type.toUpperCase() }}
                                            </el-tag>
                                            
                                            <!-- Beacon Details -->
                                            <div v-if="mfgData.type === 'ibeacon'" style="margin-top: 8px;">
                                                <el-descriptions :column="1" size="small">
                                                    <el-descriptions-item label="UUID">
                                                        {{ mfgData.uuid ? mfgData.uuid.substring(0, 8) + '...' : '' }}
                                                    </el-descriptions-item>
                                                    <el-descriptions-item label="Major/Minor">
                                                        {{ mfgData.major || 0 }}/{{ mfgData.minor || 0 }}
                                                    </el-descriptions-item>
                                                    <el-descriptions-item v-if="mfgData.estimated_distance" label="Distance">
                                                        <el-text type="primary">üìç ~{{ mfgData.estimated_distance.toFixed(1) }} meters</el-text>
                                                    </el-descriptions-item>
                                                </el-descriptions>
                                            </div>
                                            
                                            <!-- Eddystone Details -->
                                            <div v-if="mfgData.type === 'eddystone'" style="margin-top: 8px;">
                                                <el-descriptions :column="1" size="small">
                                                    <el-descriptions-item label="Frame">{{ mfgData.frame_type }}</el-descriptions-item>
                                                    <el-descriptions-item v-if="mfgData.url" label="URL">
                                                        <el-link :href="mfgData.url" target="_blank" type="primary">{{ mfgData.url }}</el-link>
                                                    </el-descriptions-item>
                                                </el-descriptions>
                                            </div>
                                            
                                            <!-- AirPods Details -->
                                            <div v-if="mfgData.type === 'airpods'" style="margin-top: 8px;">
                                                <el-text v-if="mfgData.model" size="small">Model: {{ mfgData.model }}</el-text>
                                                <el-space wrap style="margin-top: 4px;">
                                                    <el-tag v-if="mfgData.left_battery !== null" size="small"
                                                           :type="mfgData.left_battery < 20 ? 'danger' : 'info'">
                                                        L: {{ mfgData.left_battery }}%
                                                    </el-tag>
                                                    <el-tag v-if="mfgData.right_battery !== null" size="small"
                                                           :type="mfgData.right_battery < 20 ? 'danger' : 'info'">
                                                        R: {{ mfgData.right_battery }}%
                                                    </el-tag>
                                                    <el-tag v-if="mfgData.case_battery !== null" size="small"
                                                           :type="mfgData.case_battery < 20 ? 'danger' : 'info'">
                                                        Case: {{ mfgData.case_battery }}%
                                                    </el-tag>
                                                </el-space>
                                                <div v-if="mfgData.charging">
                                                    <el-text type="success" size="small">üîå Charging</el-text>
                                                </div>
                                            </div>
                                            
                                            <!-- Raw data -->
                                            <el-collapse v-if="!mfgData.type || mfgData.raw_hex" style="margin-top: 8px;">
                                                <el-collapse-item :title="`Raw data (${mfgData.raw_length || 0} bytes)`">
                                                    <div style="font-family: monospace; word-break: break-all; background-color: #F5F7FA; padding: 8px; border-radius: 4px;">
                                                        {{ mfgData.raw_hex || 'No data' }}
                                                    </div>
                                                </el-collapse-item>
                                            </el-collapse>
                                        </div>
                                    </div>
                                    
                                    <!-- Fallback -->
                                    <div v-else>
                                        <el-text type="info" size="small" style="font-style: italic;">
                                            No manufacturer data available
                                        </el-text>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <el-space>
                                    <el-button 
                                        size="small"
                                        :type="device.connected ? 'success' : 'primary'"
                                        :loading="device.connecting"
                                        :disabled="device.connected"
                                        @click="connectDevice(device.address)"
                                    >
                                        {{ device.connected ? 'Connected' : device.connecting ? 'Connecting...' : 'Connect' }}
                                    </el-button>
                                    <el-button size="small" @click="device.showDetails = !device.showDetails">
                                        Details
                                    </el-button>
                                </el-space>
                                
                                <!-- Expandable Details -->
                                <el-collapse-transition>
                                    <div v-show="device.showDetails" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E4E7ED;">
                                        <el-button 
                                            size="small"
                                            :disabled="!device.connected"
                                            @click="getServices(device.address)"
                                            style="width: 100%; margin-bottom: 8px;"
                                        >
                                            Discover Services
                                        </el-button>
                                        
                                        <!-- Services List -->
                                        <div v-if="device.services && device.services.length > 0" class="manufacturer-details">
                                            <el-text strong size="small">Services:</el-text>
                                            <div v-for="service in device.services" :key="service.uuid" 
                                                 style="background-color: #F5F7FA; padding: 8px; margin-top: 4px; border-radius: 4px;">
                                                <el-text size="small" style="font-family: monospace;">{{ service.uuid }}</el-text>
                                                <br>
                                                <el-text type="info" size="small">{{ service.characteristics.length }} characteristics</el-text>
                                            </div>
                                        </div>
                                    </div>
                                </el-collapse-transition>
                            </el-card>
                        </el-col>
                    </el-row>
                    
                    <!-- Empty State -->
                    <el-empty v-if="Object.keys(devices).length === 0" description="No devices discovered yet">
                        <el-button type="primary" @click="startScan" :loading="loading">Start Scanning</el-button>
                    </el-empty>
                </div>
            </el-main>
        </el-container>
        
        <!-- Error Notification handled by Element Plus -->
    </div>
    
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    devices: {},
                    scanning: false,
                    loading: false,
                    wsConnected: false,
                    ws: null,
                    error: null,
                    filter: {
                        name: '',
                        minRssi: -100
                    },
                    sortBy: 'rssi'
                };
            },
            
            computed: {
                filteredAndSortedDevices() {
                    let filtered = Object.values(this.devices).filter(device => {
                        if (this.filter.name && !device.name?.toLowerCase().includes(this.filter.name.toLowerCase())) {
                            return false;
                        }
                        if (device.rssi < this.filter.minRssi) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    return filtered.sort((a, b) => {
                        switch (this.sortBy) {
                            case 'rssi':
                                return b.rssi - a.rssi;
                            case 'name':
                                return (a.name || 'ZZZ').localeCompare(b.name || 'ZZZ');
                            case 'discovered':
                                return new Date(b.timestamp) - new Date(a.timestamp);
                            case 'distance':
                                const getDistance = (device) => {
                                    for (const mfg of Object.values(device.decoded_manufacturer || {})) {
                                        if (mfg.estimated_distance) {
                                            return mfg.estimated_distance;
                                        }
                                    }
                                    return 999999;
                                };
                                return getDistance(a) - getDistance(b);
                            default:
                                return 0;
                        }
                    });
                }
            },
            
            mounted() {
                this.connectWebSocket();
                this.checkScanStatus();
            },
            
            methods: {
                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        this.wsConnected = true;
                        console.log('WebSocket connected');
                    };
                    
                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    };
                    
                    this.ws.onclose = () => {
                        this.wsConnected = false;
                        console.log('WebSocket disconnected');
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },
                
                handleWebSocketMessage(message) {
                    switch (message.type) {
                        case 'device_created':
                        case 'device_discovered':
                            this.addOrUpdateDevice(message.data);
                            break;
                        case 'device_updated':
                            const { address, changes, timestamp } = message.data;
                            this.addOrUpdateDevice(
                                {
                                    address: address,
                                    timestamp: new Date(timestamp).toISOString(),
                                    ...changes,
                                }
                            )
                            break;
                        case 'scan_started':
                            this.scanning = true;
                            break;
                        case 'scan_stopped':
                            this.scanning = false;
                            break;
                        case 'device_connected':
                            this.updateDeviceStatus(message.data.address, { connected: true, connecting: false });
                            break;
                        case 'device_disconnected':
                            this.updateDeviceStatus(message.data.address, { connected: false });
                            break;
                    }
                },
                
                async checkScanStatus() {
                    try {
                        const response = await fetch('/api/v1/scan/status');
                        const data = await response.json();
                        this.scanning = data.is_scanning;
                    } catch (error) {
                        console.error('Failed to check scan status:', error);
                    }
                },
                
                async toggleScan() {
                    if (this.scanning) {
                        await this.stopScan();
                    } else {
                        await this.startScan();
                    }
                },
                
                async startScan() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const response = await fetch('/api/v1/scan/start', {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to start scan');
                        }
                        
                        this.scanning = true;
                        this.devices = {};
                    } catch (error) {
                        this.$message.error('Failed to start scan');
                        console.error(error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async stopScan() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const response = await fetch('/api/v1/scan/stop', {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to stop scan');
                        }
                        
                        this.scanning = false;
                    } catch (error) {
                        this.$message.error('Failed to stop scan');
                        console.error(error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                addOrUpdateDevice(deviceData) {
                    const device = {
                        ...deviceData,
                        timestamp: new Date(deviceData.timestamp).toISOString(),
                        decoded_manufacturer: {
                            ...(this.devices[deviceData.address]?.decoded_manufacturer || {}),
                            ...(deviceData.decoded_manufacturer || {})
                        },
                        showDetails: this.devices[deviceData.address]?.showDetails || false,
                        connected: this.devices[deviceData.address]?.connected || false,
                        connecting: this.devices[deviceData.address]?.connecting || false,
                        services: this.devices[deviceData.address]?.services || []
                    };
                    
                    this.devices = {
                        ...this.devices,
                        [device.address]: device
                    };
                },
                
                updateDeviceStatus(address, status) {
                    if (this.devices[address]) {
                        Object.assign(this.devices[address], status);
                    }
                },
                
                async connectDevice(address) {
                    this.updateDeviceStatus(address, { connecting: true });
                    this.error = null;
                    
                    try {
                        const response = await fetch(`/api/v1/devices/${address}/connect`, {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to connect');
                        }
                    } catch (error) {
                        this.$message.error(`Failed to connect to ${address}`);
                        this.updateDeviceStatus(address, { connecting: false });
                    }
                },
                
                async getServices(address) {
                    this.error = null;
                    
                    try {
                        const response = await fetch(`/api/v1/devices/${address}/services`);
                        
                        if (!response.ok) {
                            throw new Error('Failed to get services');
                        }
                        
                        const data = await response.json();
                        this.devices[address].services = data.services;
                    } catch (error) {
                        this.$message.error(`Failed to get services for ${address}`);
                    }
                },
                
                getRssiColor(rssi) {
                    if (rssi >= -50) return '#67C23A';
                    if (rssi >= -70) return '#E6A23C';
                    if (rssi >= -85) return '#F56C6C';
                    return '#F56C6C';
                },
                
                getRssiType(rssi) {
                    if (rssi >= -50) return 'success';
                    if (rssi >= -70) return 'warning';
                    return 'danger';
                },
                
                getRssiStrength(rssi) {
                    if (rssi >= -50) return 'Excellent';
                    if (rssi >= -70) return 'Good';
                    if (rssi >= -85) return 'Fair';
                    return 'Weak';
                },
                
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString();
                },
                
                getDeviceCountByType(type) {
                    return Object.values(this.devices).filter(device => 
                        Object.values(device.decoded_manufacturer || {}).some(mfg => mfg.type === type)
                    ).length;
                },
                
                getDeviceTypeTagType(type) {
                    switch (type) {
                        case 'ibeacon': return 'primary';
                        case 'eddystone': return 'success';
                        case 'airpods': return 'warning';
                        default: return 'info';
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
